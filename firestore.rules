
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper Functions
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    function isSignedIn() {
      return request.auth != null;
    }

    // Users Collection
    // Each user can read/write their own profile.
    match /users/{userId} {
      allow read, update, delete: if isOwner(userId);
      allow create: if isSignedIn(); 
    }

    // Personal Bank Accounts
    // Only the owner can manage their personal bank accounts.
    match /users/{userId}/bankAccounts/{accountId} {
      allow read, write: if isOwner(userId);
    }
    
    // Shared Bank Accounts
    // Any member of a shared account can read it.
    // Writes are handled through transactions and a more permissive ruleset is needed here,
    // but the transaction logic itself will enforce permissions.
    match /shared/data/bankAccounts/{accountId} {
      allow read: if isSignedIn() && resource.data.members[request.auth.uid] == true;
      allow write: if isSignedIn(); // Writes are complex and controlled by transactions.
    }

    // Personal Categories
    match /users/{userId}/categories/{categoryId} {
      allow read, write: if isOwner(userId);
    }
    
    // Personal Payees
    match /users/{userId}/payees/{payeeId} {
        allow read, write: if isOwner(userId);
    }

    // Personal Incomes, Expenses, Checks, Loans, Goals, Transfers, Payments
    // These are all user-specific and can only be accessed by the owner.
    match /users/{userId}/{collection}/{docId} {
      allow read, write: if isOwner(userId);
    }
  }
}

    