
{
  "description": "Technical specification for migrating the Khanevadati app backend from Firebase/Firestore to Supabase/PostgreSQL. This is the complete and corrected version.",
  "firestore": {
    "description": "Source Data Model (Firebase/Firestore). This structure will be mapped to PostgreSQL tables. The single-document model ('family-data' -> 'shared-data') will be flattened into multiple related tables in SQL.",
    "collections": {
      "family-data": {
        "documents": {
          "shared-data": {
            "subcollections": {
              "users": {
                "description": "User profiles. Maps to a 'users' table linked to 'auth.users'.",
                "documents": {
                  "[userId]": {
                    "fields": [
                      { "name": "id", "type": "string", "description": "Primary Key (matches auth UID)." },
                      { "name": "email", "type": "string", "description": "User's email." },
                      { "name": "firstName", "type": "string", "description": "User's first name." },
                      { "name": "lastName", "type": "string", "description": "User's last name." },
                      { "name": "createdAt", "type": "string", "format": "date-time", "description": "Timestamp of creation." },
                      { "name": "updatedAt", "type": "string", "format": "date-time", "description": "Timestamp of last update." }
                    ]
                  }
                }
              },
              "bankAccounts": {
                "description": "Bank accounts. Maps to 'bank_accounts' table.",
                "documents": {
                  "[accountId]": {
                    "fields": [
                      { "name": "id", "type": "string", "description": "Primary Key." },
                      { "name": "ownerId", "type": "string", "enum": ["ali", "fatemeh", "shared_account"], "description": "Indicates account ownership." },
                      { "name": "balance", "type": "number", "description": "Current balance." },
                      { "name": "registeredByUserId", "type": "string", "description": "Foreign Key to users.id." },
                      { "name": "createdAt", "type": "string", "format": "date-time", "description": "Timestamp of creation." },
                      { "name": "updatedAt", "type": "string", "format": "date-time", "description": "Timestamp of last update." },
                      { "name": "isDeleted", "type": "boolean", "default": false, "description": "Flag for soft delete." },
                      { "name": "deletedAt", "type": "string", "format": "date-time", "optional": true, "description": "Timestamp of soft deletion." }
                    ]
                  }
                }
              },
              "expenses": {
                "description": "Expense transactions. Maps to 'expenses' table.",
                "documents": {
                  "[expenseId]": {
                    "fields": [
                      { "name": "id", "type": "string", "description": "Primary Key." },
                      { "name": "transactionId", "type": "string", "description": "Shared UUID for atomic financial operations." },
                      { "name": "bankAccountId", "type": "string", "description": "Foreign Key to bank_accounts.id." },
                      { "name": "paidByUserId", "type": "string", "optional": true, "description": "Foreign Key to users.id, who physically made the payment." },
                      { "name": "categoryId", "type": "string", "description": "Foreign Key to categories.id." },
                      { "name": "amount", "type": "number", "description": "Expense amount." },
                      { "name": "date", "type": "string", "format": "date-time", "description": "Date of expense." },
                      { "name": "createdAt", "type": "string", "format": "date-time", "description": "Timestamp of creation." },
                      { "name": "updatedAt", "type": "string", "format": "date-time", "description": "Timestamp of last update." }
                    ]
                  }
                }
              },
              "income": {
                "description": "Income transactions. Maps to 'incomes' table.",
                "documents": {
                  "[incomeId]": {
                    "fields": [
                      { "name": "id", "type": "string", "description": "Primary Key." },
                      { "name": "transactionId", "type": "string", "description": "Shared UUID for atomic financial operations." },
                      { "name": "incomeSource", "type": "string", "enum": ["ali", "fatemeh", "shared"], "description": "Who earned the income. Used for reporting." },
                      { "name": "bankAccountId", "type": "string", "description": "Foreign Key to bank_accounts.id." },
                      { "name": "bankAccountOwner", "type": "string", "enum": ["ali", "fatemeh", "shared_account"], "description": "Owner of the destination bank account." },
                      { "name": "amount", "type": "number", "description": "Income amount." },
                      { "name": "date", "type": "string", "format": "date-time", "description": "Date of income." },
                      { "name": "createdAt", "type": "string", "format": "date-time", "description": "Timestamp of creation." },
                      { "name": "updatedAt", "type": "string", "format": "date-time", "description": "Timestamp of last update." }
                    ]
                  }
                }
              },
              "transfers": {
                "description": "Internal account transfers. Maps to 'transfers' table.",
                "documents": {
                  "[transferId]": {
                    "fields": [
                      { "name": "id", "type": "string", "description": "Primary Key." },
                      { "name": "transactionId", "type": "string", "description": "Shared UUID for atomic financial operations." },
                      { "name": "fromBankAccountId", "type": "string", "description": "FK to bank_accounts.id (source)." },
                      { "name": "toBankAccountId", "type": "string", "description": "FK to bank_accounts.id (destination)." },
                      { "name": "amount", "type": "number", "description": "Amount transferred." },
                      { "name": "transferDate", "type": "string", "format": "date-time", "description": "Date of transfer." },
                      { "name": "createdAt", "type": "string", "format": "date-time", "description": "Timestamp of creation." },
                      { "name": "updatedAt", "type": "string", "format": "date-time", "description": "Timestamp of last update." }
                    ]
                  }
                }
              },
              "loans": {
                "description": "Loans taken (money borrowed). Maps to 'loans' table.",
                "documents": {
                  "[loanId]": {
                    "fields": [
                      { "name": "id", "type": "string", "description": "Primary Key." },
                      { "name": "ownerId", "type": "string", "enum": ["ali", "fatemeh", "shared"], "description": "Who is responsible for the loan." },
                      { "name": "registeredByUserId", "type": "string", "description": "FK to users.id, who registered the loan." },
                      { "name": "payeeId", "type": "string", "optional": true, "description": "FK to payees.id, the lender." },
                      { "name": "amount", "type": "number", "description": "Total loan amount." },
                      { "name": "installmentAmount", "type": "number", "description": "Amount of each installment." },
                      { "name": "remainingAmount", "type": "number", "description": "The amount yet to be paid." },
                      { "name": "startDate", "type": "string", "format": "date-time", "description": "Date the loan was taken." },
                      { "name": "firstInstallmentDate", "type": "string", "format": "date-time", "description": "Due date of the first payment." },
                      { "name": "numberOfInstallments", "type": "number", "description": "Total number of installments." },
                      { "name": "paidInstallments", "type": "number", "description": "Number of paid installments." },
                      { "name": "depositToAccountId", "type": "string", "optional": true, "description": "FK to bank_accounts.id, if amount was deposited." },
                      { "name": "createdAt", "type": "string", "format": "date-time", "description": "Timestamp of creation." },
                      { "name": "updatedAt", "type": "string", "format": "date-time", "description": "Timestamp of last update." },
                      { "name": "isDeleted", "type": "boolean", "default": false, "description": "Flag for soft delete." },
                      { "name": "deletedAt", "type": "string", "format": "date-time", "optional": true, "description": "Timestamp of soft deletion." }
                    ]
                  }
                }
              },
              "loanPayments": {
                "description": "Records of loan payments. Maps to 'loan_payments' table.",
                "documents": {
                  "[paymentId]": {
                    "fields": [
                      { "name": "id", "type": "string", "description": "Primary Key." },
                      { "name": "transactionId", "type": "string", "description": "Shared UUID for atomic financial operations." },
                      { "name": "loanId", "type": "string", "description": "Foreign Key to loans.id." },
                      { "name": "bankAccountId", "type": "string", "description": "Foreign Key to bank_accounts.id." },
                      { "name": "amount", "type": "number", "description": "Amount paid." },
                      { "name": "paymentDate", "type": "string", "format": "date-time", "description": "Date of payment." },
                      { "name": "createdAt", "type": "string", "format": "date-time", "description": "Timestamp of creation." },
                      { "name": "updatedAt", "type": "string", "format": "date-time", "description": "Timestamp of last update." }
                    ]
                  }
                }
              },
              "previousDebts": {
                "description": "Informal debts. Maps to 'previous_debts' table.",
                "documents": {
                  "[debtId]": {
                    "fields": [
                      { "name": "id", "type": "string", "description": "Primary Key." },
                      { "name": "ownerId", "type": "string", "enum": ["ali", "fatemeh", "shared"], "description": "Who the debt is for." },
                      { "name": "payeeId", "type": "string", "description": "FK to payees.id, the person owed." },
                      { "name": "amount", "type": "number", "description": "Total debt amount." },
                      { "name": "remainingAmount", "type": "number", "description": "Amount yet to be paid." },
                      { "name": "startDate", "type": "string", "format": "date-time", "description": "Date the debt was incurred." },
                      { "name": "dueDate", "type": "string", "format": "date-time", "optional": true, "description": "Due date for single-payment debts." },
                      { "name": "createdAt", "type": "string", "format": "date-time", "description": "Timestamp of creation." },
                      { "name": "updatedAt", "type": "string", "format": "date-time", "description": "Timestamp of last update." },
                      { "name": "isDeleted", "type": "boolean", "default": false, "description": "Flag for soft delete." },
                      { "name": "deletedAt", "type": "string", "format": "date-time", "optional": true, "description": "Timestamp of soft deletion." }
                    ]
                  }
                }
              },
              "debtPayments": {
                "description": "Records of debt payments. Maps to 'debt_payments' table.",
                "documents": {
                  "[paymentId]": {
                    "fields": [
                      { "name": "id", "type": "string", "description": "Primary Key." },
                      { "name": "transactionId", "type": "string", "description": "Shared UUID for atomic financial operations." },
                      { "name": "debtId", "type": "string", "description": "Foreign Key to previous_debts.id." },
                      { "name": "bankAccountId", "type": "string", "description": "Foreign Key to bank_accounts.id." },
                      { "name": "amount", "type": "number", "description": "Amount paid." },
                      { "name": "paymentDate", "type": "string", "format": "date-time", "description": "Date of payment." },
                      { "name": "createdAt", "type": "string", "format": "date-time", "description": "Timestamp of creation." },
                      { "name": "updatedAt", "type": "string", "format": "date-time", "description": "Timestamp of last update." }
                    ]
                  }
                }
              },
              "financialGoals": {
                "description": "Financial goals. Maps to 'financial_goals' table.",
                "documents": {
                  "[goalId]": {
                    "fields": [
                      { "name": "id", "type": "string", "description": "Primary Key." },
                      { "name": "name", "type": "string", "description": "Name of the goal." },
                      { "name": "targetAmount", "type": "number", "description": "The target amount." },
                      { "name": "currentAmount", "type": "number", "description": "Currently saved amount." },
                      { "name": "targetDate", "type": "string", "format": "date-time", "description": "Planned achievement date." },
                      { "name": "isAchieved", "type": "boolean", "default": false, "description": "Is the goal achieved?" },
                      { "name": "createdAt", "type": "string", "format": "date-time", "description": "Timestamp of creation." },
                      { "name": "updatedAt", "type": "string", "format": "date-time", "description": "Timestamp of last update." },
                      { "name": "isDeleted", "type": "boolean", "default": false, "description": "Flag for soft delete." },
                      { "name": 'deletedAt', "type": "string", "format": "date-time", "optional": true, "description": "Timestamp of soft deletion." }
                    ]
                  }
                }
              },
              "goalContributions": {
                "description": "Contributions towards a financial goal. Maps to 'goal_contributions' table.",
                "documents": {
                  "[contributionId]": {
                    "fields": [
                      { "name": "id", "type": "string", "description": "Primary Key." },
                      { "name": "transactionId", "type": "string", "description": "Shared UUID with the corresponding expense." },
                      { "name": "goalId", "type": "string", "description": "Foreign Key to financial_goals.id." },
                      { "name": "bankAccountId", "type": "string", "description": "Foreign Key to bank_accounts.id." },
                      { "name": "amount", "type": "number", "description": "Contribution amount." },
                      { "name": "date", "type": "string", "format": "date-time", "description": "Date of contribution." },
                      { "name": "createdAt", "type": "string", "format": "date-time", "description": "Timestamp of creation." },
                      { "name": "updatedAt", "type": "string", "format": "date-time", "description": "Timestamp of last update." }
                    ]
                  }
                }
              },
              "chatMessages": {
                "description": "Chat messages. Maps to 'chat_messages' table.",
                "documents": {
                  "[messageId]": {
                    "fields": [
                      { "name": "id", "type": "string", "description": "Primary Key." },
                      { "name": "senderId", "type": "string", "description": "FK to users.id or 'system'." },
                      { "name": "text", "type": "string", "description": "Message content." },
                      { "name": "readBy", "type": "jsonb", "description": "Array of user UIDs who have read it." },
                      { "name": "replyTo", "type": "jsonb", "optional": true, "description": "Details of the message being replied to." },
                      { "name": "createdAt", "type": "string", "format": "date-time", "description": "Timestamp of creation." },
                      { "name": "updatedAt", "type": "string", "format": "date-time", "description": "Timestamp of last update." }
                    ]
                  }
                }
              }
            }
          }
        }
      }
    }
  },
  "migrationGuide": {
    "description": "A guide for the technical migration from Firestore to Supabase/PostgreSQL.",
    "sqlDataModel": {
      "introduction": "Firestore's nested subcollections will be flattened into separate PostgreSQL tables. Document references become foreign key constraints.",
      "foreignKeyRelationships": [
        { "from": "expenses.bankAccountId", "to": "bank_accounts.id" },
        { "from": "incomes.bankAccountId", "to": "bank_accounts.id" },
        { "from": "transfers.fromBankAccountId", "to": "bank_accounts.id" },
        { "from": "transfers.toBankAccountId", "to": "bank_accounts.id" },
        { "from": "loans.payeeId", "to": "payees.id" },
        { "from": "loans.depositToAccountId", "to": "bank_accounts.id" },
        { "from": "loan_payments.loanId", "to": "loans.id" },
        { "from": "previous_debts.payeeId", "to": "payees.id" },
        { "from": "debt_payments.debtId", "to": "previous_debts.id" },
        { "from": "goal_contributions.goalId", "to": "financial_goals.id" }
      ]
    },
    "databaseIndexes": {
      "introduction": "Indexes should be created on frequently queried columns for performance.",
      "recommendedIndexes": [
        "transactionId",
        "date (on all transaction tables)",
        "paymentDate (on payment tables)",
        "dueDate (on checks, debts)",
        "createdAt",
        "updatedAt",
        "ownerId",
        "incomeSource",
        "bankAccountId",
        "categoryId",
        "payeeId",
        "loanId",
        "debtId",
        "goalId",
        "isDeleted"
      ]
    }
  }
}
