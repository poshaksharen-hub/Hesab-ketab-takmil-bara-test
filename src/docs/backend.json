{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user in the Hesab Ketab application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the User entity."
        },
        "email": {
          "type": "string",
          "description": "Email address of the user.",
          "format": "email"
        },
        "firstName": {
          "type": "string",
          "description": "First name of the user."
        },
        "lastName": {
            "type": "string",
            "description": "Last name of the user."
        },
        "signatureImage": {
            "type": "string",
            "description": "URL to the user's signature image file."
        }
      },
      "required": [
        "id",
        "email",
        "firstName",
        "lastName"
      ]
    },
    "BankAccount": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "BankAccount",
      "type": "object",
      "description": "Represents a bank account. Ownership is determined by the ownerId field.",
      "properties": {
        "id": { "type": "string" },
        "ownerId": { "type": "string", "enum": ["ali", "fatemeh", "shared_account"], "description": "The owner of this account. Can be a person or the family's shared account." },
        "bankName": { "type": "string" },
        "accountNumber": { "type": "string" },
        "cardNumber": { "type": "string" },
        "expiryDate": { "type": "string", "pattern": "^(0[1-9]|1[0-2])\\/([0-9]{2})$", "description": "Expiry date in MM/YY format." },
        "cvv2": { "type": "string" },
        "accountType": { "type": "string", "enum": ["checking", "savings"], "description": "Type of the bank account." },
        "balance": { "type": "number" },
        "initialBalance": { "type": "number" },
        "blockedBalance": { "type": "number", "description": "Amount blocked for financial goals."},
        "theme": { "type": "string" }
      },
      "required": ["id", "ownerId", "bankName", "accountNumber", "cardNumber", "expiryDate", "cvv2", "accountType", "balance", "initialBalance"]
    },
    "Income": {
      "$schema": "http://json-schema.org/draft_07/schema#",
      "title": "Income",
      "type": "object",
      "description": "Represents an income transaction.",
      "properties": {
        "id": { "type": "string" },
        "ownerId": { "type": "string", "enum": ["ali", "fatemeh", "daramad_moshtarak"], "description": "The ownership category of the income source (a person or the shared business)." },
        "registeredByUserId": { "type": "string", "description": "The user who registered this transaction." },
        "bankAccountId": { "type": "string" },
        "amount": { "type": "number" },
        "date": { "type": "string", "format": "date-time" },
        "description": { "type": "string" },
        "source": { "type": "string" },
        "type": { "type": "string", "enum": ["income"] },
        "category": { "type": "string", "description": "Always 'درآمد'" },
        "createdAt": { "type": "string", "format": "date-time" },
        "balanceAfter": { "type": "number" }
      },
      "required": ["id", "ownerId", "registeredByUserId", "bankAccountId", "amount", "date", "description", "source", "type", "category", "createdAt"]
    },
    "Expense": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Expense",
      "type": "object",
      "description": "Represents an expense transaction.",
      "properties": {
        "id": { "type": "string" },
        "ownerId": { "type": "string", "enum": ["ali", "fatemeh", "shared_account"], "description": "The owner of the bank account from which the expense was made." },
        "registeredByUserId": { "type": "string", "description": "The user who registered this transaction." },
        "bankAccountId": { "type": "string" },
        "categoryId": { "type": "string" },
        "payeeId": { "type": "string", "description": "Optional ID of the payee for this expense." },
        "amount": { "type": "number" },
        "date": { "type": "string", "format": "date-time" },
        "description": { "type": "string" },
        "type": { "type": "string", "enum": ["expense"] },
        "subType": { "type": "string", "enum": ["goal_saved_portion", "goal_cash_portion", "loan_payment", "debt_payment", "goal_contribution"], "description": "Differentiates special expenses." },
        "expenseFor": { "type": "string", "enum": ["ali", "fatemeh", "shared"], "description": "The person or purpose this expense was for (beneficiary)." },
        "checkId": { "type": "string" },
        "goalId": { "type": "string" },
        "loanPaymentId": { "type": "string" },
        "debtPaymentId": { "type": "string" },
        "createdAt": { "type": "string", "format": "date-time" },
        "balanceBefore": { "type": "number" },
        "balanceAfter": { "type": "number" }
      },
      "required": ["id", "ownerId", "registeredByUserId", "bankAccountId", "categoryId", "amount", "date", "description", "type", "createdAt", "expenseFor"]
    },
    "Category": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Category",
      "type": "object",
      "description": "Represents a category for expenses, shared by all users.",
      "properties": {
        "id": { "type": "string" },
        "name": { "type": "string" },
        "description": { "type": "string" }
      },
      "required": ["id", "name"]
    },
    "Payee": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Payee",
      "type": "object",
      "description": "Represents a payee, shared by all users.",
      "properties": {
        "id": { "type": "string" },
        "name": { "type": "string" },
        "phoneNumber": { "type": "string" }
      },
      "required": ["id", "name"]
    },
    "Check": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Check",
      "type": "object",
      "description": "Represents a financial check.",
      "properties": {
        "id": { "type": "string" },
        "registeredByUserId": { "type": "string" },
        "ownerId": { "type": "string", "enum": ["ali", "fatemeh", "shared_account"], "description": "Who owns this liability (person or shared account)." },
        "expenseFor": { "type": "string", "enum": ["ali", "fatemeh", "shared"], "description": "The person or purpose this check was for (beneficiary)." },
        "bankAccountId": { "type": "string" },
        "payeeId": { "type": "string" },
        "categoryId": { "type": "string" },
        "amount": { "type": "number" },
        "issueDate": { "type": "string", "format": "date-time" },
        "dueDate": { "type": "string", "format": "date-time" },
        "status": { "type": "string", "enum": ["pending", "cleared"] },
        "clearedDate": { "type": "string", "format": "date-time", "description": "The date the check was cleared." },
        "description": { "type": "string" },
        "sayadId": { "type": "string", "description": "The Sayad ID of the check." },
        "checkSerialNumber": { "type": "string", "description": "The serial number of the check." },
        "signatureDataUrl": { "type": "string", "description": "Data URI of the check signature image."}
      },
      "required": ["id", "registeredByUserId", "ownerId", "expenseFor", "bankAccountId", "payeeId", "categoryId", "amount", "issueDate", "dueDate", "status", "sayadId", "checkSerialNumber"]
    },
    "FinancialGoalContribution": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "FinancialGoalContribution",
      "type": "object",
      "description": "Represents a single contribution towards a financial goal.",
      "properties": {
        "id": { "type": "string" },
        "bankAccountId": { "type": "string" },
        "amount": { "type": "number" },
        "date": { "type": "string", "format": "date-time" },
        "registeredByUserId": { "type": "string", "description": "The user who registered this contribution." }
      },
      "required": ["id", "bankAccountId", "amount", "date", "registeredByUserId"]
    },
    "FinancialGoal": {
        "$schema": "http://json-schema.org/draft-07/schema#",
        "title": "FinancialGoal",
        "type": "object",
        "description": "Represents a financial savings goal.",
        "properties": {
            "id": { "type": "string" },
            "registeredByUserId": { "type": "string" },
            "ownerId": { "type": "string", "enum": ["ali", "fatemeh", "shared"], "description": "Who this goal is for (beneficiary)." },
            "name": { "type": "string" },
            "targetAmount": { "type": "number" },
            "currentAmount": { "type": "number" },
            "actualCost": { "type": "number", "description": "The real cost of the goal when it was achieved." },
            "targetDate": { "type": "string", "format": "date-time" },
            "isAchieved": { "type": "boolean" },
            "priority": { "type": "string", "enum": ["low", "medium", "high"] },
            "contributions": {
                "type": "array",
                "items": {
                    "$ref": "#/entities/FinancialGoalContribution"
                }
            }
        },
        "required": ["id", "registeredByUserId", "ownerId", "name", "targetAmount", "currentAmount", "targetDate", "isAchieved", "priority", "contributions"]
    },
    "Loan": {
        "$schema": "http://json-schema.org/draft-07/schema#",
        "title": "Loan",
        "type": "object",
        "description": "Represents a loan.",
        "properties": {
            "id": { "type": "string" },
            "registeredByUserId": { "type": "string" },
            "ownerId": { "type": "string", "enum": ["ali", "fatemeh", "shared"], "description": "Who the loan is for (beneficiary)." },
            "payeeId": { "type": "string" },
            "title": { "type": "string" },
            "amount": { "type": "number" },
            "installmentAmount": { "type": "number" },
            "remainingAmount": { "type": "number" },
            "startDate": { "type": "string", "format": "date-time" },
            "firstInstallmentDate": { "type": "string", "format": "date-time", "description": "The exact date of the first installment payment."},
            "numberOfInstallments": { "type": "number" },
            "paidInstallments": { "type": "number" },
            "depositToAccountId": { "type": "string", "description": "The ID of the bank account where the loan amount was deposited." },
            "paymentDay": { "type": "number", "description": "The day of the month for installment payment reminders (1-30)." }
        },
        "required": ["id", "registeredByUserId", "ownerId", "title", "amount", "installmentAmount", "remainingAmount", "startDate", "numberOfInstallments", "paidInstallments", "firstInstallmentDate"]
    },
    "LoanPayment": {
        "$schema": "http://json-schema.org/draft-07/schema#",
        "title": "LoanPayment",
        "type": "object",
        "description": "Represents a payment towards a loan.",
        "properties": {
            "id": { "type": "string" },
            "registeredByUserId": { "type": "string" },
            "loanId": { "type": "string" },
            "bankAccountId": { "type": "string" },
            "amount": { "type": "number" },
            "paymentDate": { "type": "string", "format": "date-time" }
        },
        "required": ["id", "registeredByUserId", "loanId", "bankAccountId", "amount", "paymentDate"]
    },
    "PreviousDebt": {
        "$schema": "http://json-schema.org/draft-07/schema#",
        "title": "PreviousDebt",
        "type": "object",
        "description": "Represents a miscellaneous debt that is not a formal loan or check.",
        "properties": {
            "id": { "type": "string" },
            "registeredByUserId": { "type": "string" },
            "ownerId": { "type": "string", "enum": ["ali", "fatemeh", "shared"], "description": "Who the debt is for (beneficiary)." },
            "payeeId": { "type": "string" },
            "description": { "type": "string" },
            "amount": { "type": "number" },
            "remainingAmount": { "type": "number" },
            "startDate": { "type": "string", "format": "date-time" },
            "isInstallment": { "type": "boolean" },
            "dueDate": { "type": "string", "format": "date-time", "description": "Due date for single-payment debts." },
            "firstInstallmentDate": { "type": "string", "format": "date-time", "description": "Date of the first installment for installment-based debts." },
            "numberOfInstallments": { "type": "number" },
            "installmentAmount": { "type": "number" },
            "paidInstallments": { "type": "number" }
        },
        "required": ["id", "registeredByUserId", "ownerId", "payeeId", "description", "amount", "remainingAmount", "startDate", "isInstallment", "paidInstallments"]
    },
    "DebtPayment": {
        "$schema": "http://json-schema.org/draft-07/schema#",
        "title": "DebtPayment",
        "type": "object",
        "description": "Represents a payment towards a miscellaneous debt.",
        "properties": {
            "id": { "type": "string" },
            "registeredByUserId": { "type": "string" },
            "debtId": { "type": "string" },
            "bankAccountId": { "type": "string" },
            "amount": { "type": "number" },
            "paymentDate": { "type": "string", "format": "date-time" }
        },
        "required": ["id", "registeredByUserId", "debtId", "bankAccountId", "amount", "paymentDate"]
    },
    "Transfer": {
        "$schema": "http://json-schema.org/draft-07/schema#",
        "title": "Transfer",
        "type": "object",
        "description": "Represents an internal transfer between accounts.",
        "properties": {
            "id": { "type": "string" },
            "registeredByUserId": { "type": "string", "description": "The user who initiated the transfer." },
            "fromBankAccountId": { "type": "string" },
            "toBankAccountId": { "type": "string" },
            "amount": { "type": "number" },
            "transferDate": { "type": "string", "format": "date-time" },
            "description": { "type": "string" },
            "fromAccountBalanceBefore": { "type": "number" },
            "fromAccountBalanceAfter": { "type": "number" },
            "toAccountBalanceBefore": { "type": "number" },
            "toAccountBalanceAfter": { "type": "number" }
        },
        "required": ["id", "registeredByUserId", "fromBankAccountId", "toBankAccountId", "amount", "transferDate", "fromAccountBalanceBefore", "fromAccountBalanceAfter", "toAccountBalanceBefore", "toAccountBalanceAfter"]
    },
    "ChatMessage": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "ChatMessage",
      "type": "object",
      "description": "Represents a single chat message in the family chat.",
      "properties": {
        "id": { "type": "string" },
        "senderId": { "type": "string", "description": "The UID of the user who sent the message." },
        "senderName": { "type": "string", "description": "The first name of the sender." },
        "text": { "type": "string", "description": "The content of the message." },
        "timestamp": { "type": "string", "format": "date-time", "description": "The server timestamp of when the message was sent." },
        "type": { "type": "string", "enum": ["user", "system"] },
        "readBy": { "type": "array", "items": { "type": "string" } },
        "replyTo": {
            "type": "object",
            "properties": {
                "messageId": { "type": "string" },
                "text": { "type": "string" },
                "senderName": { "type": "string" }
            }
        },
        "transactionDetails": { "type": "object" }
      },
      "required": ["id", "senderId", "senderName", "text", "timestamp", "type", "readBy"]
    }
  },
  "auth": {
    "providers": [
      "password"
    ],
    "logic": {
      "description": "Authentication is limited to two specific users: 'ali@khanevadati.app' and 'fatemeh@khanevadati.app'. The login form enforces this client-side. Upon first successful login, a user profile document is created in the '/users/{userId}' collection."
    }
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "schema": { "$ref": "#/entities/User" },
          "description": "Stores user profiles. This collection is readable by all authenticated users to map user IDs to names, but each user can only write to their own document."
        }
      },
      {
        "path": "/family-data/shared-data",
        "definition": {
          "schema": {},
          "description": "A single document acting as a parent for all shared subcollections. All authenticated users have full read/write access to this document and all its subcollections."
        },
        "subcollections": [
            { "name": "bankAccounts", "schema": { "$ref": "#/entities/BankAccount" }, "description": "All bank accounts for the family." },
            { "name": "incomes", "schema": { "$ref": "#/entities/Income" }, "description": "All income records for the family." },
            { "name": "expenses", "schema": { "$ref": "#/entities/Expense" }, "description": "All expense records for the family." },
            { "name": "categories", "schema": { "$ref": "#/entities/Category" }, "description": "All expense categories for the family." },
            { "name": "payees", "schema": { "$ref": "#/entities/Payee" }, "description": "All payees for the family." },
            { "name": "checks", "schema": { "$ref": "#/entities/Check" }, "description": "All checks for the family." },
            { "name": "financialGoals", "schema": { "$ref": "#/entities/FinancialGoal" }, "description": "All financial goals for the family." },
            { "name": "loans", "schema": { "$ref": "#/entities/Loan" }, "description": "All loans for the family." },
            { "name": "loanPayments", "schema": { "$ref": "#/entities/LoanPayment" }, "description": "All loan payments for the family." },
            { "name": "previousDebts", "schema": { "$ref": "#/entities/PreviousDebt" }, "description": "All miscellaneous debts for the family." },
            { "name": "debtPayments", "schema": { "$ref": "#/entities/DebtPayment" }, "description": "All payments for miscellaneous debts." },
            { "name": "transfers", "schema": { "$ref": "#/entities/Transfer" }, "description": "All internal transfers for the family." },
            { "name": "chatMessages", "schema": { "$ref": "#/entities/ChatMessage" }, "description": "All chat messages for the family." }
        ]
      }
    ]
  },
  "businessLogic": {
    "description": "This section outlines the core business logic, calculations, and workflows of the Hesab Ketab application.",
    "coreMechanisms": {
      "registeredByUserId": {
        "title": "Tracking the Registrar",
        "description": "Every financial transaction (income, expense, check, etc.) has a 'registeredByUserId' field. This field stores the UID of the user who was logged in when the transaction was created. The UI uses this ID to look up the user's first name from the '/users' collection and display it, ensuring clarity on who registered what."
      },
      "ownerId_vs_expenseFor": {
        "title": "Ownership vs. Beneficiary",
        "description": "It's crucial to distinguish between 'ownerId' and 'expenseFor'. 'ownerId' typically refers to the owner of the asset or liability (e.g., the owner of the BankAccount). 'expenseFor' defines who the expense benefits (Ali, Fatemeh, or Shared). For example, Ali can use his personal card ('ownerId: ali') to pay for a shared expense ('expenseFor: shared')."
      },
      "atomicTransactions": {
          "title": "Atomic Operations with Firestore Transactions",
          "description": "All operations that involve multiple, related database writes are wrapped in a Firestore Transaction (`runTransaction`). This guarantees that all writes succeed or all fail together, preventing data inconsistency. For example, when an expense is recorded, decreasing the bank account balance and creating the expense document happen atomically. This is crucial for financial integrity."
      }
    },
    "dashboard": {
      "title": "Dashboard Logic",
      "summaryCalculations": {
        "title": "Summary Card Calculations",
        "netWorth": "Total Assets - Total Liabilities. This is a global calculation, not affected by filters.",
        "totalAssets": "Sum of the 'balance' field from all documents in the 'bankAccounts' collection.",
        "totalLiabilities": "Sum of 'remainingAmount' from all 'loans' + 'remainingAmount' from all 'previousDebts' + 'amount' from all 'checks' with 'status: pending'.",
        "totalIncome": "Sum of 'amount' from 'incomes' that match the current date and owner filters.",
        "totalExpense": "Sum of 'amount' from 'expenses' that match the current date and owner filters."
      },
      "filters": {
          "title": "Dashboard Filtering",
          "description": "The dashboard allows filtering by owner ('All', 'Ali', 'Fatemeh', 'Shared', 'Shared Business Income') and by date preset ('This Week', 'This Month', 'This Year'). These filters apply ONLY to the 'Total Income', 'Total Expense' cards, the income/expense chart, and the category spending chart. All other summary cards (Net Worth, Assets, Liabilities) always show global, unfiltered totals."
      }
    },
    "transactions": {
        "title": "Income and Expense Logic",
        "createExpense": "1. A Firestore Transaction is initiated. 2. It reads the source `BankAccount` document. 3. It verifies if the available balance (`balance` - `blockedBalance`) is sufficient. 4. It updates the `balance` on the bank account document (`balance` - expense.amount). 5. It creates a new document in the `expenses` collection, storing `balanceBefore` and `balanceAfter` for audit purposes. 6. A system message is sent to the chat.",
        "deleteExpense": "1. A Firestore Transaction is initiated. 2. It reads the `Expense` to be deleted and its source `BankAccount`. 3. It updates the `balance` on the bank account document (`balance` + expense.amount) to reverse the financial impact. 4. It deletes the `Expense` document.",
        "createIncome": "1. A Firestore Transaction is initiated. 2. It reads the destination `BankAccount`. 3. It updates the `balance` on the bank account (`balance` + income.amount). 4. It creates a new `Income` document with the `balanceAfter` field. 5. A system message is sent to the chat."
    },
    "liabilities": {
      "title": "Checks, Loans, and Debts",
      "checkWorkflow": {
          "title": "Check Workflow (with Signature)",
          "creation": "1. User fills the check form. 2. Upon submission, a signature dialog (`SignatureDialog`) opens. 3. The user draws their signature on a canvas. 4. On confirmation, the signature is converted to a Base64 Data URI string (`signatureDataUrl`). 5. A Firestore transaction is initiated to create a new `Check` document. 6. All check details, including the `signatureDataUrl` string, are saved in the new document. The check `status` is set to 'pending'. No financial change occurs at this stage.",
          "clearing": "1. A Firestore Transaction is initiated. 2. It reads the `Check` document and its associated `BankAccount`. 3. It verifies the bank account has sufficient available balance (`balance` - `blockedBalance`). 4. It updates the check's `status` to 'cleared' and sets the `clearedDate`. 5. It creates a new `Expense` document with a `subType` of 'check_cleared' and a reference to the check's ID, to record the financial impact. 6. It updates the `BankAccount`'s `balance` (`balance` - check.amount).",
          "deletion": "If a check is 'pending', the document is simply deleted. If it is 'cleared', a transaction runs to delete both the `Check` document and its corresponding `Expense` document, while also adding the amount back to the bank account's `balance`."
      },
      "loanAndDebtPayment": {
          "title": "Loan and Debt Payment",
          "description": "Paying a loan or debt installment is a complex atomic transaction: 1. It reads the `Loan`/`PreviousDebt` and the source `BankAccount`. 2. It verifies the bank has sufficient funds (`balance` - `blockedBalance`). 3. It updates the `remainingAmount` and `paidInstallments` on the loan/debt document. 4. It creates a `LoanPayment`/`DebtPayment` history document. 5. It creates a corresponding `Expense` document (with `subType: 'loan_payment'` or `debt_payment`) to reflect the payment in the main ledger. 6. It updates the bank account's `balance`."
      },
      "deletionConstraint": "Loans, Debts, Categories, and Payees cannot be deleted if they are referenced by any existing transaction (e.g., a 'Loan' with 'paidInstallments' > 0 cannot be deleted). This is enforced by a pre-delete check within a transaction that queries for related documents before allowing the deletion to proceed."
    },
    "goals": {
        "title": "Financial Goals",
        "contribution": "1. Adding funds to a goal is an atomic transaction. 2. A `goal_contribution` expense is created, which *reduces* the `balance` of the source bank account. 3. Simultaneously, the `blockedBalance` of the *same* bank account is *increased* by the same amount. This keeps the total `balance` field technically correct for accounting while separating spendable money from saved money. 4. The `currentAmount` on the `FinancialGoal` document is increased, and a contribution record (linking to the expense ID) is added to its `contributions` array.",
        "achievement": "1. When a goal is marked as 'achieved', another complex transaction runs. 2. It releases the 'blockedBalance' from all contributing bank accounts by subtracting the contribution amounts from the `blockedBalance` field of each respective bank. This makes the saved money 'spendable' again. 3. It creates a final `Expense` for the `actualCost`, which may use a combination of the now-unblocked savings (represented as an expense with `subType: 'goal_saved_portion'`) and new cash from a specified payment card (represented as an expense with `subType: 'goal_cash_portion'`). 4. The `isAchieved` flag on the goal is set to true, and `currentAmount` is reset to 0."
    },
    "transfers": {
        "title": "Internal Transfers",
        "logic": "1. An atomic transaction updates two `BankAccount` documents. 2. It subtracts the amount from the `from` account's `balance`. 3. It adds the amount to the `to` account's `balance`. 4. A `Transfer` document is created to log this operation, including the balances before and after for both accounts for historical accuracy and reversibility."
    },
    "chat": {
        "title": "Chat and Notifications",
        "systemMessages": "After a key financial transaction (creating an expense, income, check, loan, etc.), a `sendSystemNotification` function is called. This function creates a new `ChatMessage` document with `type: system`. The message contains a `transactionDetails` object with all relevant info, which the UI then uses to render a special summary card in the chat feed.",
        "readReceipts": "Each message has a `readBy` array field containing UIDs. When a user opens the chat, the app identifies all messages not sent by them and where their UID is not in the `readBy` array. It then performs a batch update to add their UID to all those messages, marking them as read. The UI uses this array to show a single check (sent) or double check (read by the other user)."
    }
  }
}
