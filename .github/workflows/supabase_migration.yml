
name: 'Supabase DB Push'

on:
  push:
    branches:
      - main
    paths:
      - 'supabase/migrations/**'

jobs:
  push-migrations:
    name: 'Push Supabase Migrations'
    runs-on: ubuntu-latest
    
    steps:
      - name: 'Checkout Repository'
        uses: actions/checkout@v3

      - name: 'Set up Supabase CLI'
        uses: supabase/setup-cli@v1
        with:
          version: latest
          
      - name: 'Push Migrations and Capture Output'
        id: db_push
        run: |
          supabase db push --project-ref ${{ secrets.SUPABASE_PROJECT_REF }} --db-password ${{ secrets.SUPABASE_DB_PASSWORD }} > migration_output.log 2>&1
        continue-on-error: true

      - name: 'Check for migration_output.log'
        id: check_file
        run: |
          if [ -f migration_output.log ]; then
            echo "file_exists=true" >> $GITHUB_OUTPUT
          else
            echo "file_exists=false" >> $GITHUB_OUTPUT
          fi
          
      - name: 'Upload Migration Log as Artifact'
        if: steps.check_file.outputs.file_exists == 'true'
        uses: actions/upload-artifact@v3
        with:
          name: migration-log
          path: migration_output.log
          
      - name: 'Create Pull Request with Migration Log'
        if: steps.check_file.outputs.file_exists == 'true' && steps.db_push.outcome == 'success'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GH_PAT_TOKEN }}
          commit-message: 'chore: Add migration output log'
          title: 'CI - Database Migration Output'
          body: |
            This PR was automatically created by the `Supabase DB Push` workflow.
            It contains the output of the latest database migration.
            
            **Action:** Please review the attached `migration_output.log` file.
            - If the migration was successful and the log is correct, merge this PR.
            - If there are errors, investigate the log and address the issues.
            
            This file will be deleted automatically upon merging.
          branch: 'ci/migration-log'
          delete-branch: true
          add-paths: |
            migration_output.log

