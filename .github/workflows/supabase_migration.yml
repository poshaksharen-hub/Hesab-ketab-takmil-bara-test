
name: 'Supabase DB Push'

on:
  push:
    branches:
      - main
    paths:
      - 'supabase/migrations/**'

jobs:
  push-migrations:
    name: 'Push Supabase Migrations'
    runs-on: ubuntu-latest
    
    steps:
      - name: 'Checkout Repository'
        uses: actions/checkout@v3

      - name: 'Set up Supabase CLI'
        uses: supabase/setup-cli@v1
        with:
          version: latest
          
      - name: 'Push Migrations to Supabase'
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          supabase db push --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
          
      - name: 'Check for migration_output.log'
        id: check_file
        run: |
          if [ -f migration_output.log ]; then
            echo "file_exists=true" >> $GITHUB_OUTPUT
          else
            echo "file_exists=false" >> $GITHUB_OUTPUT
          fi
          
      - name: 'Upload Migration Log as Artifact'
        if: steps.check_file.outputs.file_exists == 'true'
        uses: actions/upload-artifact@v3
        with:
          name: migration-log
          path: migration_output.log
